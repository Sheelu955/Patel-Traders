<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Patel Traders | ERP Final Fix</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800;900&display=swap');
        :root { --bhagwa: #ff9933; --bg-dark: #080a0f; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg-dark); color: #ffffff; margin: 0; padding: 0; overflow-x: hidden; }
        .glass { background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(15px); border: 1px solid rgba(255, 153, 51, 0.2); border-radius: 24px; }
        .m-input { background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 14px; padding: 16px; width: 100%; color: white; outline: none; margin-bottom: 12px; box-sizing: border-box; }
        .btn-bhagwa { background: linear-gradient(135deg, #ff9933, #cc5500); color: white; font-weight: 800; text-transform: uppercase; border-radius: 16px; padding: 18px; width: 100%; cursor: pointer; border: none; transition: 0.2s; box-shadow: 0 8px 15px rgba(255, 153, 51, 0.2); }
        .app-view { display: none; min-height: 100vh; padding: 20px; flex-direction: column; align-items: center; justify-content: center; }
        #receipt-render { width: 210mm; min-height: 297mm; background: white; color: #0f172a; padding: 18mm; border: 8px solid var(--bhagwa); position: relative; box-sizing: border-box; margin: 0 auto; }
        .stamp { position: absolute; top: 12%; right: 10%; width: 150px; height: 150px; border: 6px solid; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 900; font-size: 28px; transform: rotate(-20deg); opacity: 0.15; pointer-events: none; }
        .active-tab { background: var(--bhagwa) !important; color: white !important; }
    </style>
</head>
<body>

<div id="view-home" class="app-view" style="display: flex;">
    <div class="text-center p-10 glass w-full max-w-sm border-t-4 border-[#ff9933]">
        <img src="https://i.ibb.co/C30Ybjck/PT-20250224-170650-0000.png" class="w-24 mx-auto mb-6 rounded-3xl border-2 border-[#ff9933]" crossorigin="anonymous">
        <h1 class="text-4xl font-black italic mb-1 uppercase tracking-tighter">Patel <span class="text-[#ff9933]">Traders</span></h1>
        <h2 class="text-[#ff9933] text-[15px] font-black tracking-[0.3em] mb-1">‡§´‡§∞‡•ç‡§®‡•Ä‡§ö‡§∞ ‡§∂‡•â‡§™</h2>
        <p class="text-white/40 text-[10px] mb-8 font-bold italic">GANDHINAGAR TALGRM RURAL CHHIBRAMAU INDERGRAH MAARG</p>
        <button onclick="window.adminGatewayInit()" class="btn-bhagwa mb-4">Admin Gateway</button>
        <button onclick="window.showView('view-cust-gate')" class="w-full py-4 glass font-black uppercase text-xs tracking-widest text-[#ff9933]">Customer Vault</button>
    </div>
</div>

<div id="view-admin-gate" class="app-view">
    <div id="pinDots" class="flex gap-5 mb-10"><div class="w-4 h-4 rounded-full border-2 border-white/30"></div><div class="w-4 h-4 rounded-full border-2 border-white/30"></div><div class="w-4 h-4 rounded-full border-2 border-white/30"></div><div class="w-4 h-4 rounded-full border-2 border-white/30"></div></div>
    <div class="grid grid-cols-3 gap-5 w-full max-w-xs">
        <script>for(let i=1;i<=9;i++) document.write(`<button onclick="window.pressPin('${i}')" class="py-6 glass font-black text-2xl text-white rounded-2xl active:bg-[#ff9933]">${i}</button>`)</script>
        <button onclick="window.clearP()" class="py-6 font-black text-rose-500">CLR</button>
        <button onclick="window.pressPin('0')" class="py-6 glass font-black text-2xl text-white rounded-2xl active:bg-[#ff9933]">0</button>
        <button onclick="window.showView('view-home')" class="py-6 font-black text-slate-500 text-[10px]">Back</button>
    </div>
</div>

<div id="view-cust-gate" class="app-view">
    <div class="glass p-8 w-full max-w-sm border-b-4 border-[#ff9933]">
        <h2 class="text-2xl font-black text-white text-center mb-8 uppercase italic">Vault Access</h2>
        <div id="authTabs" class="flex gap-2 mb-6 bg-black/40 p-1 rounded-xl">
            <button id="tL" onclick="window.toggleAuth('login')" class="flex-1 py-3 rounded-lg font-black uppercase text-[10px] active-tab">Login</button>
            <button id="tR" onclick="window.toggleAuth('reg')" class="flex-1 py-3 rounded-lg font-black uppercase text-[10px] text-slate-400">Register</button>
        </div>
        <div id="boxL"><input type="text" id="lU" placeholder="Username" class="m-input"><input type="password" id="lP" placeholder="Password" class="m-input"><button onclick="window.handleLogin()" class="btn-bhagwa mt-2">Unlock Vault</button></div>
        <div id="boxR" style="display: none;"><input type="text" id="rN" placeholder="Full Name" class="m-input"><input type="text" id="rPh" placeholder="Mobile No" class="m-input"><input type="text" id="rU" placeholder="Set Username" class="m-input"><input type="password" id="rP" placeholder="Set Password" class="m-input"><button onclick="window.handleReg()" class="btn-bhagwa mt-2">Create Vault ID</button></div>
        <button onclick="window.showView('view-home')" class="w-full text-slate-600 text-[10px] mt-8 uppercase border-t border-white/5 pt-4">‚Üê Exit</button>
    </div>
</div>

<div id="view-admin-app" class="app-view" style="align-items: flex-start;">
    <div class="w-full max-w-7xl mx-auto flex flex-col lg:flex-row gap-8 py-6">
        <div class="w-full lg:w-1/3 p-6 glass border-t-4 border-[#ff9933]">
            <h2 class="text-xl font-black mb-6 uppercase italic">Billing Hub</h2>
            <div class="flex gap-2 mb-6 bg-black/40 p-1 rounded-xl">
                <button onclick="window.setBillMode('PAID')" id="mP" class="w-1/2 py-3 rounded-lg font-black text-[10px] active-tab">PAID</button>
                <button onclick="window.setBillMode('UNPAID')" id="mU" class="w-1/2 py-3 rounded-lg font-black text-[10px] text-white">UNPAID</button>
            </div>
            <input type="text" id="inName" oninput="window.sync()" placeholder="Customer Name" class="m-input">
            <input type="text" id="inPhone" oninput="window.sync()" placeholder="Mobile No" class="m-input">
            <input type="text" id="inVehicle" oninput="window.sync()" placeholder="Vehicle No" class="m-input">
            <input type="text" id="inItem" oninput="window.sync()" placeholder="Furniture Item" class="m-input">
            <div class="flex gap-2"><input type="number" id="inAmt" oninput="window.sync()" placeholder="‚Çπ Base" class="m-input w-1/2"><input type="number" id="inDisc" oninput="window.sync()" placeholder="‚Çπ Disc" class="m-input w-1/2"></div>
            <select id="inWarranty" onchange="window.sync()" class="m-input"><option>No Warranty</option><option>1 Year</option><option>5 Years</option></select>
            <textarea id="inDetail" oninput="window.sync()" placeholder="Extra Details..." class="m-input h-16"></textarea>
            <input type="text" id="inPostDate" oninput="window.sync()" placeholder="Due Date (DD/MM/YYYY)" class="m-input" style="display:none">
            <button onclick="window.saveBillMaster()" class="btn-bhagwa mt-4">Save & Print Bill</button>
            <button onclick="window.showView('view-home')" class="w-full py-2 text-slate-500 uppercase mt-4 text-[9px]">Logout Admin</button>
        </div>

        <div class="w-full lg:w-2/3 bg-slate-900/50 p-6 rounded-[40px]">
            <div id="receipt-render">
                <div id="stP" class="stamp" style="color: #10b981; border-color: #10b981;">PAID</div><div id="stU" class="stamp" style="display:none; color: #ef4444; border-color: #ef4444;">PENDING</div>
                <div class="flex justify-between border-b-2 pb-6 border-slate-100">
                    <img src="https://i.ibb.co/C30Ybjck/PT-20250224-170650-0000.png" class="w-24 rounded-2xl" crossorigin="anonymous">
                    <div class="text-right">
                        <h1 class="text-4xl font-black uppercase text-slate-900">Patel Traders</h1>
                        <p class="text-[11px] font-black text-slate-800 uppercase">GANDHINAGAR TALGRAM RURAL 209731 KUNNAUJ UTTAR PRADESH</p>
                        <p class="text-[11px] font-black text-slate-500 italic">‡§∏‡§Ç‡§ú‡§Ø ‡§ï‡•Å‡§Æ‡§æ‡§∞: +91 9565697314</p>
                    </div>
                </div>
                <div class="grid grid-cols-2 my-10 font-bold uppercase text-slate-800">
                    <div><p class="text-slate-400 text-[10px]">Customer</p><h3 id="vName" class="text-3xl font-black italic">Guest</h3><p id="vPhone" class="text-slate-500">+91 0000000000</p><p class="mt-2 text-[10px]">Vehicle: <span id="vVehicle">--</span></p></div>
                    <div class="text-right text-[12px]">INV: <span id="vInv">#AUTO</span><br>DATE: <span id="vDate">--</span><br>WAR: <span id="vWar">None</span></div>
                </div>
                <div class="min-h-[200px] border-y-2 py-8 font-black uppercase text-slate-800 border-slate-100">
                    <table class="w-full"><tr><td class="text-2xl italic"><span id="vItem">Item</span><br><small id="vDetail" class="text-xs normal-case text-slate-400 font-bold"></small></td><td id="vBase" class="text-right text-2xl">‚Çπ 0</td></tr></table>
                </div>
                <div class="mt-10 p-8 bg-slate-50 rounded-[40px] flex justify-between items-center border border-slate-100">
                    <div><p class="text-[11px] text-slate-400 font-black">PAYABLE AMOUNT</p><h2 id="vTotal" class="text-6xl font-black text-slate-900">‚Çπ 0</h2></div>
                    <div class="text-right"><p id="vPostDisplay" class="text-rose-600 font-black text-sm"></p><p class="text-[9px] text-slate-400 mt-2">Certified Digital Receipt</p></div>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="view-cust-app" class="app-view" style="justify-content: flex-start;">
    <div class="w-full max-w-5xl mx-auto py-6">
        <div class="flex justify-between items-center glass p-10 border-l-8 border-[#ff9933] mb-8">
            <div><h2 class="text-4xl font-black uppercase">My <span class="text-[#ff9933]">Vault</span></h2><p id="cNameDisplay" class="text-xs text-[#ff9933] font-bold">Verified Owner</p></div>
            <button onclick="location.reload()" class="px-8 py-3 bg-rose-600 text-white font-black rounded-xl text-xs uppercase">Logout</button>
        </div>

        <div class="glass p-6 mb-6 border-l-4 border-emerald-500 bg-emerald-500/5">
            <h3 class="text-emerald-400 font-black text-[11px] mb-4 uppercase tracking-widest text-center md:text-left">üîç Find Missing Receipt</h3>
            <div class="flex flex-col md:flex-row gap-3">
                <input type="text" id="linkInvInput" placeholder="Invoice No (e.g. PT-B-123)" class="m-input m-0 flex-1">
                <input type="text" id="linkDateInput" placeholder="Date (DD/MM/YYYY)" class="m-input m-0 flex-1">
                <button onclick="window.linkAndOpenReceipt()" class="btn-bhagwa px-8 py-3 m-0 text-xs shadow-none">Search Bill</button>
            </div>
        </div>

        <div id="uGrid" class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-12"></div>
        <div id="pGrid" class="grid grid-cols-1 md:grid-cols-3 gap-6 pb-20"></div>
    </div>
</div>

<script>
    // ‚öôÔ∏è FIXED CONFIG & URL
    const CONFIG = { 
        URL: "https://script.google.com/macros/s/AKfycbyqGgozh6soglW6b_8s7LSr96_gIGNaweAnG1CQn-_F5HytVi9pYGi3GDX-lSz-mEyD/exec", 
        ID: "14", 
        PIN: "7314" 
    };

    window.pCode = ""; window.bMode = "PAID"; window.activeU = null; window.dbRecs = [];

    window.showView = (vId) => { document.querySelectorAll('.app-view').forEach(v => v.style.display = 'none'); document.getElementById(vId).style.display = 'flex'; };

    window.adminGatewayInit = () => { if (prompt("Admin ID:") === CONFIG.ID) window.showView('view-admin-gate'); };

    window.pressPin = (n) => {
        if (window.pCode.length < 4) window.pCode += n;
        document.querySelectorAll('#pinDots div').forEach((x, i) => x.style.background = i < window.pCode.length ? '#ff9933' : 'transparent');
        if (window.pCode === CONFIG.PIN) { window.showView('view-admin-app'); window.sync(); window.pCode = ""; }
    };

    window.clearP = () => { window.pCode = ""; document.querySelectorAll('#pinDots div').forEach(x => x.style.background = 'transparent'); };

    window.toggleAuth = (t) => {
        document.getElementById('boxL').style.display = t === 'login' ? 'block' : 'none';
        document.getElementById('boxR').style.display = t === 'reg' ? 'block' : 'none';
        document.getElementById('tL').className = t === 'login' ? 'flex-1 py-3 rounded-lg font-black uppercase text-[10px] active-tab' : 'flex-1 py-3 rounded-lg font-black uppercase text-[10px] text-slate-400';
        document.getElementById('tR').className = t === 'reg' ? 'flex-1 py-3 rounded-lg font-black uppercase text-[10px] active-tab' : 'flex-1 py-3 rounded-lg font-black uppercase text-[10px] text-slate-400';
    };

    window.handleLogin = async () => {
        const u = document.getElementById('lU').value.trim(), p = document.getElementById('lP').value.trim();
        const res = await fetch(`${CONFIG.URL}?action=getUsers`);
        const users = await res.json();
        const found = users.find(x => String(x.user) === u && String(x.pass) === p);
        if (found) { window.activeU = found; document.getElementById('cNameDisplay').innerText = found.name; window.showView('view-cust-app'); window.loadVault(); } else alert("Error!");
    };

    window.handleReg = async () => {
        const d = { type: "USER", name: document.getElementById('rN').value, phone: document.getElementById('rPh').value, user: document.getElementById('rU').value, pass: document.getElementById('rP').value };
        await fetch(CONFIG.URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(d) });
        alert("Registered!"); window.toggleAuth('login');
    };

    window.setBillMode = (m) => {
        window.bMode = m;
        document.getElementById('mP').className = m === 'PAID' ? 'w-1/2 py-3 rounded-lg font-black text-[10px] active-tab' : 'w-1/2 py-3 rounded-lg font-black text-[10px] text-white';
        document.getElementById('mU').className = m === 'UNPAID' ? 'w-1/2 py-3 rounded-lg font-black text-[10px] active-tab' : 'w-1/2 py-3 rounded-lg font-black text-[10px] text-white';
        document.getElementById('stP').style.display = m === 'PAID' ? 'flex' : 'none';
        document.getElementById('stU').style.display = m === 'UNPAID' ? 'flex' : 'none';
        document.getElementById('inPostDate').style.display = m === 'UNPAID' ? 'block' : 'none';
        window.sync();
    };

    window.sync = () => {
        const a = parseFloat(document.getElementById('inAmt').value) || 0, d = parseFloat(document.getElementById('inDisc').value) || 0;
        document.getElementById('vName').innerText = document.getElementById('inName').value || "Guest";
        document.getElementById('vPhone').innerText = document.getElementById('inPhone').value || "0000000000";
        document.getElementById('vVehicle').innerText = document.getElementById('inVehicle').value || "--";
        document.getElementById('vItem').innerText = document.getElementById('inItem').value || "Item";
        document.getElementById('vDetail').innerText = document.getElementById('inDetail').value || "";
        document.getElementById('vTotal').innerText = "‚Çπ " + (a - d).toLocaleString();
        document.getElementById('vBase').innerText = "‚Çπ " + a.toLocaleString();
        document.getElementById('vWar').innerText = document.getElementById('inWarranty').value;
        document.getElementById('vPostDisplay').innerText = window.bMode === 'UNPAID' ? "DUE: " + document.getElementById('inPostDate').value : "";
        document.getElementById('vDate').innerText = new Date().toLocaleDateString('en-GB');
    };

    window.saveBillMaster = async () => {
        const inv = "PT-B-" + Date.now().toString().slice(-6);
        const d = { type: "BILL", inv, name: document.getElementById('inName').value, phone: document.getElementById('inPhone').value, vehicle: document.getElementById('inVehicle').value, item: document.getElementById('inItem').value, total: document.getElementById('vTotal').innerText, date: document.getElementById('vDate').innerText, mode: window.bMode, warranty: document.getElementById('inWarranty').value, detail: document.getElementById('inDetail').value, postdate: document.getElementById('inPostDate').value };
        await fetch(CONFIG.URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(d) });
        // Generate PDF
        const canvas = await html2canvas(document.getElementById('receipt-render'), {scale: 2, useCORS: true});
        const pdf = new jspdf.jsPDF('p', 'mm', 'a4');
        pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 0, 0, 210, 297);
        pdf.save(inv + ".pdf");
    };

    window.loadVault = async () => {
        const res = await fetch(`${CONFIG.URL}?action=getBills`);
        window.dbRecs = await res.json();
        const ph = String(window.activeU.phone).slice(-10);
        const mine = window.dbRecs.filter(r => String(r.phone).includes(ph));
        document.getElementById('pGrid').innerHTML = mine.filter(x=>x.mode==='PAID').map((r,i) => `<div class='glass p-6'><h3>${r.item}</h3><p>${r.total}</p><button onclick="window.handleSilentPDF(${window.dbRecs.indexOf(r)}, 'view-cust-app')" class='btn-bhagwa py-2 mt-4 text-xs shadow-none'>Download PDF</button></div>`).join('') || "No Bills";
        document.getElementById('uGrid').innerHTML = mine.filter(x=>x.mode!=='PAID').map(r => `<div class='glass p-6 border-rose-500/20'><h3>${r.item}</h3><p class='text-rose-500 font-bold'>${r.total}</p></div>`).join('') || "No Dues";
    };

    window.linkAndOpenReceipt = async () => {
        const inv = document.getElementById('linkInvInput').value.trim().toUpperCase();
        const dt = document.getElementById('linkDateInput').value.trim();
        const foundIdx = window.dbRecs.findIndex(r => String(r.inv).toUpperCase() === inv && String(r.date) === dt);
        if(foundIdx !== -1) window.handleSilentPDF(foundIdx, 'view-cust-app'); else alert("Bill Not Found!");
    };

    // üõ†Ô∏è REWRITTEN PDF FUNCTION (STRICT NO-GUEST POLICY)
    window.handleSilentPDF = async function(idx, ret) {
        const r = window.dbRecs[idx];
        const v = document.getElementById('view-admin-app');
        
        // Step 1: Force UI Switch
        v.style.display = 'flex'; v.style.opacity = '0.01'; v.style.position = 'fixed';
        
        // Step 2: Hard-Inject Data into DOM
        const nameEl = document.getElementById('vName');
        const phoneEl = document.getElementById('vPhone');
        
        nameEl.innerText = r.name;
        phoneEl.innerText = r.phone;
        document.getElementById('vVehicle').innerText = r.vehicle || "--";
        document.getElementById('vInv').innerText = r.inv;
        document.getElementById('vTotal').innerText = r.total;
        document.getElementById('vItem').innerText = r.item;
        document.getElementById('vDetail').innerText = r.detail || "";
        document.getElementById('vWar').innerText = r.warranty || "None";
        document.getElementById('vDate').innerText = r.date;
        document.getElementById('stP').style.display = r.mode === 'PAID' ? 'flex' : 'none';
        document.getElementById('stU').style.display = r.mode !== 'PAID' ? 'flex' : 'none';

        // Step 3: Verify and Capture (Wait for DOM to settle)
        setTimeout(async () => {
            if (nameEl.innerText === "Guest") { // Double Check
                nameEl.innerText = r.name; 
                phoneEl.innerText = r.phone;
            }
            
            const canvas = await html2canvas(document.getElementById('receipt-render'), {
                scale: 2, 
                useCORS: true,
                allowTaint: true,
                logging: false
            });
            
            const pdf = new jspdf.jsPDF('p', 'mm', 'a4');
            pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 0, 0, 210, 297);
            pdf.save(r.inv + "_" + r.name + ".pdf");
            
            // Step 4: Reset
            v.style.display = 'none'; v.style.opacity = '1'; v.style.position = 'relative';
            window.showView(ret);
        }, 1200); // 1.2 seconds delay for safe rendering
    };
</script>
</body>
</html>
